var Map3=function(options){this.initialize(options),this.timeArray=[],this.dataMap={},this.build(),this.breadcrumbs()};Map3.prototype.initialize=function(options){this.zoomTime=250;for(var attr in options)this[attr]=options[attr];this.events={},this.cargs={},this.level=0,this.label="string"==typeof this.label?[this.label]:this.label,this.levels="undefined"==typeof this.levels?[]:this.levels,this.scope="map3-"+(new Date).getTime();var $container=$("<div></div>");$container.attr("id",this.scope),this.scope="#"+this.scope,$(this.container).append($container)},Map3.prototype.build=function(){this.treemap=d3plus.viz();var thiz=this;this.treemap.config({container:this.scope,type:"tree_map",id:this.label,labels:{align:"center",valign:"top"},size:{value:thiz.size,threshold:!1}}),this.treemap.tooltip({html:function(e){return""}}),this.treemap.format({text:function(text,params){return"undefined"!=typeof params&&"undefined"!=typeof params.data&&params.key==thiz.label?thiz.textFormat(params.data):d3plus.string.title(text,params)},number:function(number,params){return"undefined"!=typeof params&&"undefined"!=typeof params.data&&params.key==thiz.size?thiz.sizeFormat(params.data):d3plus.number.format(number,params)}}),this.treemap.mouse({move:!0,click:function(d,viz){thiz.beforeClick(d,viz)}}),"undefined"!=typeof thiz.time&&(this.time.solo="undefined"==typeof this.time.solo?[]:this.time.solo,this.treemap.time(this.time))},Map3.prototype.on=function(event,handler){this.events[event]=handler},Map3.prototype.trigger=function(event,data){"undefined"!=typeof this.events[event]&&this.events[event](data)},Map3.prototype.beforeClick=function(d,viz){this.level<this.levels.length-1&&0!=this.levels.length&&(this.zoom(d),this.updateBreadcrumbs(d),this.dataMap[this.level]=d,this.level+=1,"undefined"!=typeof this.time&&(this.time.solo=d[this.time.value]),this.trigger("drill-down",d))},Map3.prototype.config=function(options){for(var key in options)this.treemap[key](options[key]),this.cargs[key]=options[key]},Map3.prototype.textFormat=function(data){var text=data[this.label];return text.charAt(0).toUpperCase()+text.substr(1).toLowerCase()},Map3.prototype.sizeFormat=function(data){var n=data[this.size];return n},Map3.prototype.redraw=function(data){$(this.scope).html(""),this.build(),this.data(data),this.config(this.cargs)},Map3.prototype.data=function(data){this.treemap.data(data),this.treemap.draw();this.treemap.total()},Map3.prototype.animate=function($el,attrs,speed,callback){if(speed=speed||400,0!=$el.length){var start={},timeout=20,steps=Math.floor(speed/timeout),cycles=steps;$.each(attrs,function(k,v){start[k]=$el.attr(k)}),function loop(){$.each(attrs,function(k,v){var pst;if("transform"==k){var translate=function(value){var valueXY=value.replace("translate(","").replace(")scale(1)");valueXY=valueXY.split(",");var pst={};return pst.x=parseFloat(valueXY[0]),pst.y=parseFloat(valueXY[1]),pst},pst=translate(start[k]);return pst.x=-pst.x/steps,pst.y=-pst.y/steps,void $el.attr(k,function(i,old){var oldVal=translate(old),cx=oldVal.x+pst.x,cy=oldVal.y+pst.y;return"translate("+cx+","+cy+")scale(1)"})}var getNumber=function(val){var value="undefined"!=typeof val?val:0;return isNaN(value)&&(value=parseFloat(value.replace("px"))),value},value=getNumber(start[k]);v=getNumber(v),pst=(v-value)/steps;var sufix=value==start[k]?"":"px";$el.attr(k,function(i,old){var result=+getNumber(old)+pst;return result+sufix})}),--cycles?setTimeout(loop,timeout):($el.attr(attrs),callback&&callback($el,attrs))}()}},Map3.prototype.getEl=function(data){return $('[transform*="translate('+data.d3plus.x+","+data.d3plus.y+')"]')},Map3.prototype.zoom=function(data){var $g=this.getEl(data),w=$(this.scope).css("width").replace("px",""),h=$(this.scope).css("height").replace("px","");w=parseFloat(w)+50,h=parseFloat(h)+50;var half=w/2,time=this.zoomTime,$target=$g.clone(),$share=$target.find("text.d3plus_share"),textColor=$share.attr("fill");$share.remove();var $text=$target.find("text"),textValue=this.textFormat(data);if(0==$text.length){var $rect=$target.find(".d3plus_data");textColor=d3plus.color.text($rect.attr("fill")),$text=d3.select($target[0]).append("text").attr("font-size","40px").attr("text-anchor","middle").attr("stroke","none").attr("fill",textColor),$text.append("tspan").attr("x","0px").attr("dy","44px").attr("dominant-baseline","alphabetic").text(textValue),$text=$rect.find("text")}else if(1==$text.length){for(var $tspan=$target.find("tspan"),i=1;i<$tspan.length;i++)$($tspan[i]).remove();$tspan.text(textValue)}var $rect=$target.find("rect"),$tspam=$target.find("tspan"),lineCount=$tspam.length,chartCount=$tspam.first().text().trim().length,tmpSize=w/chartCount*2;tmpSize=parseInt(tmpSize),tmpSize=lineCount>7?h/(2*lineCount):tmpSize,tmpSize=tmpSize>50?50:tmpSize;var fontSize=tmpSize+"px",textPosition=5>=lineCount?"100px":"10px";this.animate($rect,{width:w,height:h,x:0,y:0},time,function($el,attrs){$rect.attr("style","opacity:0.9;")}),this.animate($target,{transform:"translate(0,0)scale(1)"},time),this.animate($tspam,{x:half+"px",dy:tmpSize+4+"px",dx:"0px"},time),$text.removeAttr("style"),this.animate($text,{"font-size":fontSize,y:textPosition},time,function($el,attrs){$text.attr("style","opacity:1;")}),$target.attr("id","tmp-zoom-g"),$("#d3plus_viz").append($target)},Map3.prototype.breadcrumbs=function(){for(var $ul=$("<ul class='map3-breadcrumbs'/>"),$liTmpl=$("<li / >"),$aTmpl=$("<a class='map3-levels disable'/>"),i=0;i<this.levels.length;i++){var $li=$liTmpl.clone(),aId="map3-li-lvl-"+i,$a=$aTmpl.clone();$a.attr("data-level",i),$a.attr("id",aId),$a.attr("data-name",this.levels[i]),$a.text(this.levels[i]),$li.append($a),$ul.append($li)}var $ol=$("<ol class='breadcrumb' />");$(this.container).prepend($ol),$(this.container).prepend($ul);var thiz=this;$ul.find("li").on("click",function(){$(this).find("a").hasClass("disable")||thiz.onDrillUp($(this))})},Map3.prototype.onDrillUp=function($li){var $a=$li.find("a"),level=$a.attr("data-level");this.level=parseInt(level);for(var $labels=$(this.container).find(".breadcrumb"),$brumbs=$(this.container).find(".map3-breadcrumbs"),len=$brumbs.find("[data-level]").length,i=level;len>i;i++){$labels.find("[data-level='"+i+"']").remove();var $aEl=$brumbs.find("[data-level='"+i+"']"),aId=$aEl.attr("id");$aEl.addClass("disable"),$("."+aId).remove()}var d=0==level?null:this.dataMap[this.level-1],data=$.extend({},d);data.level=level,"undefined"!=typeof this.time&&null!=data.data&&(data.data[this.time.value]=this.time.solo),this.trigger("drill-up",data)},Map3.prototype.updateBreadcrumbs=function(data){var $target=this.getEl(data),fill=$target.find("rect").attr("fill"),textColor=d3plus.color.text(fill),$brumbs=$(this.container).find(".map3-breadcrumbs"),$a=$brumbs.find("[data-level='"+this.level+"']"),aId=$a.attr("id");$a.removeClass("disable");var aStyle="<style class='{id}'>";aStyle+="a#{id}::before {border-color: {fill} {fill} {fill} transparent;}",aStyle+="li:last-child a#{id}::after {border-color: {fill} {fill} {fill} {fill};}",aStyle+="li a#{id}::after {border-left: 1em solid {fill};}",aStyle+="a#{id}{background-color: {fill}; color:{text}}",aStyle+="li:first-child a#{id}::before{border-color: {fill} {fill} {fill} {fill};}",aStyle+="</style>",aStyle=aStyle.replace(/{id}/g,aId).replace(/{fill}/g,fill).replace(/{color}/g,textColor),$a.append($(aStyle));var $labels=$(this.container).find(".breadcrumb"),$li=$("<li/ >");$li.attr("data-level",this.level);var $span=$("<span class='text'/>"),$div=$("<div class='note'/>");$span.text(this.textFormat(data)),$div.text(this.sizeFormat(data)),$li.append($span),$labels.append($li)};